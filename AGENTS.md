# ExStruct AI Agents Guide

ExStruct プロジェクトでは、AIを開発プロセスに組み込み、  
高い品質を維持しつつ迅速に機能実装・改善を行うことを目的としています。

本ドキュメントは、AI エージェントが ExStruct を開発する際に守るべき  
**役割・責務・行動規範・コード品質基準・成果物仕様** を定義します。

AIは以下の項目を必ず遵守してください。

---

## 1. ワークフロー設計

### 1. Planモードを基本とする

- 3ステップ以上 or アーキテクチャに関わるタスクは必ずPlanモードで開始する
- 途中でうまくいかなくなったら、無理に進めずすぐに立ち止まって再計画する
- 構築だけでなく、検証ステップにもPlanモードを使う
- 曖昧さを減らすため、実装前に詳細な仕様を書く

### 2. サブエージェント戦略

- メインのコンテキストウィンドウをクリーンに保つためにサブエージェントを積極的に活用する
- リサーチ・調査・並列分析はサブエージェントに任せる
- 複雑な問題には、サブエージェントを使ってより多くの計算リソースを投入する
- 集中して実行するために、サブエージェント1つにつき1タスクを割り当てる

### 3. 自己改善ループ

- ユーザーから修正を受けたら必ず `tasks/lessons.md` にそのパターンを記録する
- 同じミスを繰り返さないように、自分へのルールを書く
- ミス率が下がるまで、ルールを徹底的に改善し続ける
- セッション開始時に、そのプロジェクトに関連するlessonsをレビューする

### 4. 完了前に必ず検証する

- 動作を証明できるまで、タスクを完了とマークしない
- 必要に応じてmainブランチと自分の変更の差分を確認する
- 「スタッフエンジニアはこれを承認するか？」と自問する
- テストを実行し、ログを確認し、正しく動作することを示す

### 5. エレガントさを追求する（バランスよく）

- 重要な変更をする前に「もっとエレガントな方法はないか？」と一度立ち止まる
- ハック的な修正に感じたら「今知っていることをすべて踏まえて、エレガントな解決策を実装する」
- シンプルで明白な修正にはこのプロセスをスキップする（過剰設計しない）
- 提示する前に自分の作業に自問自答する

### 6. 自律的なバグ修正

- バグレポートを受けたら、手取り足取り教えてもらわずにそのまま修正する
- ログ・エラー・失敗しているテストを見て、自分で解決する
- ユーザーのコンテキスト切り替えをゼロにする
- 言われなくても、失敗しているCIテストを修正しに行く

---

## 2. AI の遵守すべきコーディング基準

AI は必ず次のルールに従ってコードを生成してください。

### 2.1 型ヒント必須（mypy strict 準拠）

- 全関数・メソッドに引数・戻り値の型を必ず付与する
- `Any` は外部ライブラリ境界のみで使用可（xlwings, pandas 等）

### 2.2 Pydantic BaseModel を返すこと

- 辞書やタプルを返さない
- すべての「構造化データ」は Pydantic モデルによって表現する

### 2.3 1 関数 = 1 責務

- 複雑度（C90）は 12 を超えない
- 必要なら AI が自動的に関数分割して良い

### 2.4 import の順序

1. 標準ライブラリ
2. サードパーティ
3. exstruct 内のモジュール

### 2.5 Docstring（Google スタイル）

関数・クラスには必ず Docstring を付ける。

### 2.6 外部ライブラリの内部構造に依存しない

- xlwings / pandas / numpy などは型を推測しない
- エンティティは境界層で Any として受け取り、内部で Pydantic に正規化する

---

## 4. AI が書いてはいけないコード（禁止事項）

AI は以下のコードを書いてはいけません。

### ❌ 大規模・単一関数（God Function）

### ❌ 神クラス（God Object）

### ❌ 無駄なネスト・深い条件分岐

### ❌ 辞書返却・タプル返却（Pydantic モデル必須）

### ❌ xlwings や pandas の内部型に依存するコード

### ❌ import が未整理のコード

### ❌ テスト不能な副作用だらけの関数

AI は必要であれば **禁止事項を回避するためにリファクタリングしてもよい**。

---

## 5. AI の責務外（人間が担当する領域）

AI は以下の領域は担当しません。人間が判断します。

- 仕様決定（ExStruct の拡張方向）
- 公開 API 設計（break change の判断）
- ディレクトリ構造の大規模再編
- セキュリティ・ライセンス判断

ただし、AI は**提案はしてよい**。

---

## 6. 遵守すべき作業手順

AI はコード生成前に以下の手順を必ず踏んでください。

1. **要件の理解**：仕様書や設計資料を読み込み、要件を完全に理解する
2. **設計の検討**：必要に応じて関数分割やモデル設計を検討する。
3. **仕様の定義**: 要件に基づいて、関数の引数・戻り値の型を `tasks/feature_spec.md` に定義する。
4. **タスクの割り当て**: 各タスクを明確に定義し、実装順序を決定する。
5. **コード実装**: 上記の基準を守りながらコードを実装する。
6. **コードレビュー**: 自動生成されたコードを自己レビューし、品質基準を満たしているか確認する。
7. **テストコードの生成**: 必要に応じて、テストコードも生成する。
8. **テストの実行**: 生成されたテストコードを実行し、期待通りの動作を確認する。
9. **静的解析**: `uv run task precommit-run` を実行し、mypy / Ruff エラーがないことを確認する。
10. **ドキュメントの更新**: 変更があれば、関連するドキュメントも更新する。

---

## タスク管理

1. **まず計画を立てる**：チェック可能な項目として `tasks/todo.md` に計画を書く
2. **計画を確認する**：実装を開始する前に確認する
3. **進捗を記録する**：完了した項目を随時マークしていく
4. **変更を説明する**：各ステップで高レベルのサマリーを提供する
5. **結果をドキュメント化する**：`tasks/todo.md` にレビューセクションを追加する
6. **学びを記録する**：修正を受けた後に `tasks/lessons.md` を更新する

---

## コア原則

- **シンプル第一**：すべての変更をできる限りシンプルにする。影響するコードを最小限にする。
- **手を抜かない**：根本原因を見つける。一時的な修正は避ける。シニアエンジニアの水準を保つ。
- **影響を最小化する**：変更は必要な箇所のみにとどめる。バグを新たに引き込まない。
